<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Playlist Duration Calculator</title>
    <style>
        /* CSS styles from part 1 */
        /* You can copy the styles from part 1 here */
    </style>
</head>
<body>
    <!-- HTML content from part 1 -->
    <!-- You can copy the HTML content from part 1 here -->
    
    <script>
        // Define version number as a variable at the top
        const APP_VERSION = "3.7";
        
        // Global variables
        let calcPlayer = null;
        let youtubePlayer = null;
        let playlistId = null;
        let videoData = [];
        let playlistTitle = "YouTube Playlist";
        let currentVideoIndex = 0;
        const YOUTUBE_API_KEY = 'AIzaSyD3EZr_d99qLJX_2gZQuaENVCbClbjgHWE'; // Use your actual key
        
        // Helper function to parse duration
        function parseDuration(duration) {
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return 0; // Handle cases where regex doesn't match
            const hours = parseInt(match[1] || 0);
            const minutes = parseInt(match[2] || 0);
            const seconds = parseInt(match[3] || 0);
            return hours * 3600 + minutes * 60 + seconds;
        }
        
        // Fetch playlist data from YouTube API
        async function fetchPlaylistDataFromYouTubeAPI(pId, showDetails) {
            console.log(`Fetching API data for Playlist ID: ${pId}, Show Details: ${showDetails}`);
            const loadingDiv = document.getElementById('loading');
            try {
                // Fetch playlist details
                const playlistResponse = await fetch(
                    `https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${pId}&key=${YOUTUBE_API_KEY}`
                );
                if (!playlistResponse.ok) {
                    const errorData = await playlistResponse.json().catch(() => ({})); // Try to parse error, default to empty obj
                    console.error("API Error (Playlist Details):", playlistResponse.status, errorData);
                    throw new Error(`Failed to fetch playlist details: ${errorData?.error?.message || playlistResponse.statusText} (Status: ${playlistResponse.status})`);
                }
                const playlistData = await playlistResponse.json();
                if (!playlistData.items || playlistData.items.length === 0) {
                    throw new Error('Playlist not found or is empty/private.');
                }
                playlistTitle = playlistData.items[0].snippet.title || "YouTube Playlist";
                console.log("Playlist Title:", playlistTitle);

                // Fetch playlist items (videos)
                let videos = [];
                let nextPageToken = null;
                let page = 1;
                do {
                    console.log(`Fetching playlist items page ${page++}...`);
                    const videosResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&maxResults=50&playlistId=${pId}${nextPageToken ? `&pageToken=${nextPageToken}` : ''}&key=${YOUTUBE_API_KEY}`
                    );
                    if (!videosResponse.ok) {
                        const errorData = await videosResponse.json().catch(() => ({}));
                        console.error("API Error (Playlist Items):", videosResponse.status, errorData);
                        throw new Error(`Failed to fetch playlist items: ${errorData?.error?.message || videosResponse.statusText} (Status: ${videosResponse.status})`);
                    }
                    const videosPageData = await videosResponse.json();
                    if (!videosPageData.items) {
                        console.warn("No items found on this page, but continuing if nextPageToken exists.");
                    } else {
                         videos = videos.concat(videosPageData.items);
                    }
                    nextPageToken = videosPageData.nextPageToken;
                } while (nextPageToken);
                console.log(`Fetched a total of ${videos.length} video items.`);

                if (videos.length === 0) {
                    throw new Error("No videos found in the playlist.");
                }

                // Prepare video data structure
                videoData = videos
                    .filter(item => item.snippet && item.snippet.title && item.contentDetails && item.contentDetails.videoId) // Basic validation
                    .map(item => ({
                        title: item.snippet.title,
                        duration: 0, // Will be filled if showDetails is true
                        videoId: item.contentDetails.videoId,
                        error: false
                    }));

                if (showDetails) {
                    console.log("Fetching detailed video durations...");
                    // Batch fetch video details for duration
                    const videoIds = videoData.map(v => v.videoId);
                    let detailedVideoInfo = [];
                    const batchSize = 50;
                    for (let i = 0; i < videoIds.length; i += batchSize) {
                        const batchIds = videoIds.slice(i, i + batchSize).join(',');
                        console.log(`Fetching details for batch ${Math.floor(i / batchSize) + 1}...`);
                        const detailsResponse = await fetch(
                            `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${batchIds}&key=${YOUTUBE_API_KEY}`
                        );
                         if (!detailsResponse.ok) {
                            const errorData = await detailsResponse.json().catch(() => ({}));
                            console.error("API Error (Video Details):", detailsResponse.status, errorData);
                            // Don't throw here, just log and continue - some videos might be unavailable
                            console.warn(`Failed to fetch details for batch starting at index ${i}. Some durations might be missing.`);
                            continue; // Skip this batch
                        }
                        const detailsData = await detailsResponse.json();
                        if(detailsData.items) {
                            detailedVideoInfo = detailedVideoInfo.concat(detailsData.items);
                        }
                    }

                    // Create a map for easy lookup
                    const detailsMap = new Map(detailedVideoInfo.map(item => [item.id, item.contentDetails]));

                    // Update videoData with durations
                    let totalSeconds = 0;
                    let validVideos = 0;
                    videoData = videoData.map(video => {
                        const details = detailsMap.get(video.videoId);
                        if (details && details.duration) {
                            const durationSeconds = parseDuration(details.duration);
                            if (durationSeconds > 0) { // Ensure duration is valid
                                video.duration = durationSeconds;
                                totalSeconds += durationSeconds;
                                validVideos++;
                            } else {
                                console.warn(`Invalid duration format for video ${video.videoId}: ${details.duration}`);
                                video.error = true; // Mark as error if duration couldn't be parsed
                            }
                        } else {
                            console.warn(`No details found for video ${video.videoId}`);
                            video.error = true; // Mark as error if no details found
                        }
                        return video;
                    });

                    // Display results
                    displayResults(playlistTitle, videoData.length, validVideos, totalSeconds, true);
                    
                    // Initialize player
                    initYoutubePlayer();
                } else {
                    // For fast mode, use the embedded player to calculate durations
                    initCalculationPlayer();
                }

                return true;
            } catch (error) {
                console.error('Error in fetchPlaylistDataFromYouTubeAPI:', error);
                showError(`Failed to fetch playlist data: ${error.message}`);
                return false;
            }
        }
        
        // Start calculation process
        function startCalculation() {
            console.log('startCalculation called');
            
            // Reset UI state
            document.getElementById('result').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('progress').style.width = '0%';
            document.getElementById('progress').textContent = '0%';
            document.getElementById('progress-text').textContent = '0/0';
            
            // Get playlist URL
            const url = document.getElementById('playlistUrl').value.trim();
            if (!url) {
                showError('Please enter a YouTube playlist URL');
                return;
            }
            
            // Extract playlist ID
            playlistId = extractPlaylistId(url);
            if (!playlistId) {
                showError('Invalid YouTube playlist URL. Please enter a valid URL or playlist ID.');
                return;
            }
            
            console.log(`Extracted Playlist ID: ${playlistId}`);
            
            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            
            // Get selected mode
            const detailedMode = document.querySelector('input[name="mode"][value="detailed"]').checked;
            
            // Process playlist
            if (detailedMode) {
                document.getElementById('progress-container').style.display = 'block';
                fetchPlaylistDataFromYouTubeAPI(playlistId, true);
            } else {
                // Fast mode uses the embedded player
                fetchPlaylistDataFromYouTubeAPI(playlistId, false);
            }
        }
        
        // Extract playlist ID from URL
        function extractPlaylistId(url) {
            console.log('Extracting playlist ID from:', url);
            
            // If it's already just an ID (no slashes or dots)
            if (/^[A-Za-z0-9_-]+$/.test(url) && url.length > 10) {
                return url;
            }
            
            // Try to extract from URL
            const listMatch = url.match(/[?&]list=([A-Za-z0-9_-]+)/);
            if (listMatch && listMatch[1]) {
                return listMatch[1];
            }
            
            return null;
        }
        
        // Show error message
        function showError(message) {
            console.error('Error:', message);
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('progress-container').style.display = 'none';
        }
        
        // Initialize YouTube API
        function initYouTubeAPI() {
            console.log('Initializing YouTube API');
            const tag = document.createElement('script');
            tag.src = 'https://www.youtube.com/iframe_api';
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        
        // Initialize YouTube player for playback
        function initYoutubePlayer() {
            console.log('Initializing YouTube player for playback');
            if (youtubePlayer) {
                youtubePlayer.destroy();
            }
            
            youtubePlayer = new YT.Player('youtube-player', {
                height: '390',
                width: '640',
                playerVars: {
                    listType: 'playlist',
                    list: playlistId,
                    // Removed web-share feature and simplified player parameters
                    controls: 1, 
                    autoplay: 1, 
                    rel: 0, 
                    modestbranding: 1, 
                    fs: 1, 
                    iv_load_policy: 3, 
                    enablejsapi: 1
                },
                events: {
                    'onReady': onPlaybackPlayerReady,
                    'onStateChange': onPlaybackPlayerStateChange,
                    'onError': onPlaybackPlayerError
                }
            });
        }
        
        // Initialize YouTube player for calculation
        function initCalculationPlayer() {
            console.log('Initializing YouTube player for calculation');
            document.getElementById('progress-container').style.display = 'block';
            
            if (calcPlayer) {
                calcPlayer.destroy();
            }
            
            // Create a hidden div for the calculation player
            let calcPlayerDiv = document.getElementById('calc-player');
            if (!calcPlayerDiv) {
                calcPlayerDiv = document.createElement('div');
                calcPlayerDiv.id = 'calc-player';
                calcPlayerDiv.style.display = 'none';
                document.body.appendChild(calcPlayerDiv);
            }
            
            calcPlayer = new YT.Player('calc-player', {
                height: '1',
                width: '1',
                playerVars: {
                    listType: 'playlist',
                    list: playlistId,
                    controls: 0, 
                    autoplay: 1, 
                    rel: 0, 
                    modestbranding: 1, 
                    fs: 0, 
                    iv_load_policy: 3, 
                    enablejsapi: 1
                },
                events: {
                    'onReady': onCalculationPlayerReady,
                    'onStateChange': onCalculationPlayerStateChange,
                    'onError': onCalculationPlayerError
                }
            });
        }
        
        // Handle YouTube player errors
        function onPlaybackPlayerError(event) {
            console.error('Playback Player Error:', event.data);
            handlePlayerError(event.data, 'playback');
        }
        
        function onCalculationPlayerError(event) {
            console.error('Calculation Player Error:', event.data);
            handlePlayerError(event.data, 'calculation');
        }
        
        function handlePlayerError(errorCode, playerType) {
            let errorMessage = 'An unknown error occurred';
            
            switch(errorCode) {
                case 2:
                    errorMessage = 'Invalid parameter value';
                    break;
                case 5:
                    errorMessage = 'The requested content cannot be played';
                    break;
                case 100:
                    errorMessage = 'The video requested was not found';
                    break;
                case 101:
                case 150:
                    errorMessage = 'The owner of the requested video does not allow it to be played in embedded players';
                    break;
            }
            
            showError(`YouTube ${playerType} player error: ${errorMessage} (Code: ${errorCode})`);
        }
        
        // Player event handlers
        function onPlaybackPlayerReady(event) {
            console.log('Playback Player Ready');
            // Start playing the first video in the playlist
            if (videoData.length > 0) {
                event.target.loadVideoById(videoData[currentVideoIndex].videoId);
            }
        }
        
        function onPlaybackPlayerStateChange(event) {
            console.log('Playback Player State Changed:', event.data);
            // Handle player state changes if needed
        }
        
        function onCalculationPlayerReady(event) {
            console.log('Calculation Player Ready');
            // Get the playlist data
            try {
                const playlist = event.target.getPlaylist();
                if (!playlist || playlist.length === 0) {
                    throw new Error('Could not get playlist data or playlist is empty');
                }
                
                console.log(`Got playlist with ${playlist.length} videos`);
                
                // Initialize video data array
                videoData = [];
                let totalDuration = 0;
                let processedVideos = 0;
                
                // Process each video
                const processNextVideo = (index) => {
                    if (index >= playlist.length) {
                        // All videos processed
                        console.log(`All ${processedVideos} videos processed. Total duration: ${totalDuration}s`);
                        displayResults(playlistTitle, playlist.length, processedVideos, totalDuration, true);
                        return;
                    }
                    
                    // Update progress
                    const progressPercent = Math.round((index / playlist.length) * 100);
                    document.getElementById('progress').style.width = `${progressPercent}%`;
                    document.getElementById('progress').textContent = `${progressPercent}%`;
                    document.getElementById('progress-text').textContent = `${index}/${playlist.length}`;
                    
                    // Load the video
                    event.target.playVideoAt(index);
                };
                
                // Start processing
                processNextVideo(0);
            } catch (error) {
                console.error('Error in onCalculationPlayerReady:', error);
                showError(`Failed to process playlist: ${error.message}`);
            }
        }
        
        function onCalculationPlayerStateChange(event) {
            console.log('Calculation Player State Changed:', event.data);
            
            // YT.PlayerState.ENDED = 0
            // YT.PlayerState.PLAYING = 1
            // YT.PlayerState.PAUSED = 2
            // YT.PlayerState.BUFFERING = 3
            
            if (event.data === YT.PlayerState.PLAYING) {
                // Video is playing, get its duration
                const duration = event.target.getDuration();
                const videoId = event.target.getVideoData().video_id;
                const title = event.target.getVideoData().title;
                
                // Add to video data array
                videoData.push({
                    videoId: videoId,
                    title: title,
                    duration: duration,
                    error: false
                });
                
                console.log(`Video ${videoData.length}: ${title} (${duration}s)`);
                
                // Move to next video after a short delay
                setTimeout(() => {
                    const nextIndex = videoData.length;
                    const playlist = event.target.getPlaylist();
                    
                    if (nextIndex < playlist.length) {
                        // Process next video
                        const progressPercent = Math.round((nextIndex / playlist.length) * 100);
                        document.getElementById('progress').style.width = `${progressPercent}%`;
                        document.getElementById('progress').textContent = `${progressPercent}%`;
                        document.getElementById('progress-text').textContent = `${nextIndex}/${playlist.length}`;
                        
                        event.target.playVideoAt(nextIndex);
                    } else {
                        // All videos processed
                        const totalDuration = videoData.reduce((sum, video) => sum + video.duration, 0);
                        console.log(`All ${videoData.length} videos processed. Total duration: ${totalDuration}s`);
                        displayResults(playlistTitle, playlist.length, videoData.length, totalDuration, true);
                        
                        // Initialize the playback player
                        initYoutubePlayer();
                    }
                }, 500);
            }
        }
        
        // Display results
        function displayResults(title, total, valid, seconds, details) {
            console.log(`displayResults called: Title=${title}, Total=${total}, Valid=${valid}, Seconds=${seconds}, Details=${details}`);
            
            // Format the duration
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            const formattedDuration = `${hours}h ${minutes}m ${secs}s`;
            
            // Calculate average video length
            const avgSeconds = valid > 0 ? Math.round(seconds / valid) : 0;
            const avgMinutes = Math.floor(avgSeconds / 60);
            const avgSecs = avgSeconds % 60;
            
            // Update the UI with playlist info
            document.getElementById('playlistInfo').innerHTML = `
                <h3>${title}</h3>
                <p><strong>Total videos:</strong> ${total}</p>
                <p><strong>Available videos:</strong> ${valid}</p>
            `;
            
            // Update the UI with duration info
            document.getElementById('durationInfo').innerHTML = `
                <p><strong>Total duration:</strong> ${formattedDuration}</p>
                <p><strong>Average video length:</strong> ${avgMinutes}m ${avgSecs}s</p>
            `;
            
            // Show video details if available
            if (details && videoData.length > 0) {
                const tableRows = videoData.map((video, index) => `
                    <tr class="clickable-row ${index === currentVideoIndex ? 'active-video' : ''}" data-index="${index}">
                        <td>${index + 1}</td>
                        <td>${video.title}</td>
                        <td>${video.error ? 'N/A' : formatDuration(video.duration)}</td>
                    </tr>
                `).join('');
                
                // Use the correct element ID - videoTableBody instead of videoList
                document.getElementById('videoTableBody').innerHTML = tableRows;
                
                // Add click event to rows for video selection with passive option
                document.querySelectorAll('.clickable-row').forEach(row => {
                    row.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        currentVideoIndex = index;
                        if (youtubePlayer) {
                            youtubePlayer.loadVideoById(videoData[index].videoId);
                        }
                        document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active-video'));
                        this.classList.add('active-video');
                    }, { passive: true });
                });
            }
            
            // Helper function to format duration in a readable format
            function formatDuration(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;
            }
            
            // Show the results section
            document.getElementById('result').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('progress-container').style.display = 'none';
        }
        
        // Initialize when YouTube API is ready
        window.onYouTubeIframeAPIReady = function() {
            console.log('YouTube API Ready');
        };
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set version numbers
            document.getElementById('version-number').textContent = APP_VERSION;
            document.getElementById('footer-version').textContent = APP_VERSION;
            
            // Set timestamps
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' };
            const formattedTime = now.toLocaleString('en-US', options);
            document.getElementById('build-time').textContent = 'Last updated: ' + formattedTime;
            document.getElementById('footer-time').textContent = formattedTime;
            
            // Attach button listener with passive option
            document.getElementById('calculateBtn').addEventListener('click', startCalculation, { passive: true });
            
            // Attach Enter key listener
            document.getElementById('playlistUrl').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    startCalculation();
                }
            }, { passive: false }); // Can't be passive because we're using preventDefault
            
            // Initialize YouTube API
            initYouTubeAPI();
            
            console.log("DOM Ready, Listeners Attached. Version:", APP_VERSION);
        });
    </script>
</body>
</html>
