
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Playlist Duration Calculator & Player</title>
    <style>
        .top-section {
            display: flex;
        }

        .bottom-section {
            margin-top: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        #youtube-link {
            width: 500px;
        }

        input {
            margin: 10px;
        }

        .input-group {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <a href="https://github.com/rickyjou/youtube-playlist">Github Repository</a>
    <br>
    <section class="top-section">
        <div id="video-youtube"></div>
        <section>
            Play List:
            <section id="play-list"></section>
        </section>
    </section>
    <section class="bottom-section">
        <section>
            <h1>Exportable Playlist:</h1>
            <textarea id="playlist-object" rows="20" cols="70">
        </textarea>
            <br>
            <button id="update-button">Update and Play from beginning</button>
            <button id="reset-button">Reset and Remove All Videos</button>
            <button id="share-button">Generate Shareable Link</button>
            <div id="share-link-container" style="display: none; margin-top: 10px;">
                <input type="text" id="share-link" readonly style="width: 500px;">
                <button id="copy-link-button">Copy Link</button>
            </div>
        </section>
        <form id="add-form">
            <h1>Add New Video Clip:</h1>
            Youtube Link: Link format must have watch?v= in the link<br />
            For example: https://www.youtube.com/watch?v=6MTbZBg9pQc<br />
            <input type="text" id="youtube-link" placeholder="Youtube Link"><br />
            Start Time:<br />
            <input type="number" name="start-time-hour" value="0">:<input type="number" name="start-time-minute"
                value="0">:<input type="number" name="start-time-second" value="0">
            <br />
            End Time:<br />
            <input type="number" name="end-time-hour" value="0">:<input type="number" name="end-time-minute"
                value="0">:<input type="number" name="end-time-second" value="0">
            <br />
            <button id="add-button">Add</button>
        </form>
    </section>

    <script id="youtube-tracking-script">
        // Check if there's a playlist in the URL
        function loadPlaylistFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const playlistParam = urlParams.get('playlist');
            
            if (playlistParam) {
                try {
                    // Decode the base64 encoded playlist
                    const decodedPlaylist = atob(playlistParam);
                    return JSON.parse(decodedPlaylist);
                } catch (e) {
                    console.error('Error loading playlist from URL:', e);
                    return null;
                }
            }
            return null;
        }

        // Initialize playlist from URL or use default
        let playList = loadPlaylistFromURL() || [{
                videoId: '6MTbZBg9pQc',
                start: 0,
                end: 761
            },
            {
                videoId: 'gUSWWqnOKt0',
                start: 0,
                end: 140
            }
        ];

        let textarea = document.getElementById('playlist-object');
        textarea.value = JSON.stringify(playList);

        let currentId = 0;

        let updateButton = document.getElementById('update-button');
        updateButton.addEventListener('click', function (event) {
            let playListString = document.getElementById('playlist-object').value;
            try {
                playList = JSON.parse(playListString);
            } catch (exception) {
                alert('JSON format error. Please check your input and try again.')
                return;
            }
            currentId = 0;
            updatePlayList();
            player.loadVideoById({
                'videoId': playList[currentId].videoId,
                'startSeconds': playList[currentId].start,
                'endSeconds': playList[currentId].end
            });
        });

        let resetButton = document.getElementById('reset-button');
        resetButton.addEventListener('click', function (event) {
            if (confirm('Are you sure you want to remove all videos from the playlist?')) {
                playList = [];
                currentId = 0;
                textarea.value = JSON.stringify(playList);
                updatePlayList();
                if (player) {
                    player.stopVideo();
                }
            }
        });

        let shareButton = document.getElementById('share-button');
        let shareLinkContainer = document.getElementById('share-link-container');
        let shareLinkInput = document.getElementById('share-link');
        let copyLinkButton = document.getElementById('copy-link-button');

        shareButton.addEventListener('click', function (event) {
            // Encode the playlist as base64
            const playlistJSON = JSON.stringify(playList);
            const encodedPlaylist = btoa(playlistJSON);
            
            // Generate the shareable URL
            const baseURL = window.location.origin + window.location.pathname;
            const shareableURL = `${baseURL}?playlist=${encodedPlaylist}`;
            
            // Display the link
            shareLinkInput.value = shareableURL;
            shareLinkContainer.style.display = 'block';
        });

        copyLinkButton.addEventListener('click', function (event) {
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999); // For mobile devices
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareLinkInput.value).then(function() {
                alert('Link copied to clipboard!');
            }).catch(function(err) {
                // Fallback for older browsers
                document.execCommand('copy');
                alert('Link copied to clipboard!');
            });
        });

        let playListElement = document.getElementById('play-list');

        function updatePlayList() {
            let totalTime = 0;
            playListElement.innerHTML = '';
            for (let i = 0; i < playList.length; i++) {
                const startTime = parseInt(playList[i].start);
                const endTime = parseInt(playList[i].end);
                totalTime += endTime - startTime;
                if (currentId == i)
                    playListElement.innerHTML += `<p>* ${i + 1}. ${playList[i].videoId}: ${formatTime(playList[i].start)} -
            ${formatTime(playList[i].end)}</p>`;
                else
                    playListElement.innerHTML += `<p> ${i + 1}. ${playList[i].videoId}: ${formatTime(playList[i].start)} -
                ${formatTime(playList[i].end)}</p>`;
            }
            const totalMinutes = Math.floor(totalTime / 60);
            const totalSeconds = totalTime % 60;
            playListElement.innerHTML += `<p>Total Time: ${totalMinutes} minutes ${totalSeconds} seconds</p>`;
            // Calculate when to start the playlist
            const startHourSeconds = 3600 - totalTime; // 1 hour = 3600 seconds
            const startMinutes = Math.floor(startHourSeconds / 60);
            const startSeconds = startHourSeconds % 60;
            const formattedStartTime = `${startMinutes}:${startSeconds < 10 ? '0' + startSeconds : startSeconds}`;
            playListElement.innerHTML += `<p>Start Playlist at: ${formattedStartTime} to finish at the top of the hour.</p>`;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds}`;
        }



        let tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";

        let firstScriptTag = document.getElementById("youtube-tracking-script");
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        let player;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('video-youtube', {
                height: '500px',
                width: '1000px',
                videoId: playList[0].videoId,
                playerlets: {
                    'autoplay': 0,
                    'start': playList[0].start,
                    'end': playList[0].end
                },
                events: {
                    'onStateChange': videoPlay
                }
            });
        }

        let debouncing = false;

        function videoPlay(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                debouncing = false;
                console.log("YouTube Video is PLAYING!!");
            }
            if (event.data == YT.PlayerState.PAUSED) {
                console.log("YouTube Video is PAUSED!!");
            }

            // after loading next video, before starting the next one, one extra end event will be passed,
            // so need this debouncing logic
            if (debouncing)
                return;
            if (event.data == YT.PlayerState.ENDED) {
                debouncing = true;
                console.log("YouTube Video is ENDING!!");
                currentId++;
                if (playList[currentId]) {
                    player.loadVideoById({
                        'videoId': playList[currentId].videoId,
                        'startSeconds': playList[currentId].start,
                        'endSeconds': playList[currentId].end
                    });
                }
                updatePlayList();
            }
        }

        const addForm = document.getElementById('add-form');
        addForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            let videoLink = document.getElementById('youtube-link').value;
            
            // Validate video link
            if (!videoLink || !videoLink.includes('v=')) {
                alert('Please enter a valid YouTube link with v= parameter');
                return;
            }
            
            // Extract video ID
            const videoId = videoLink.split('v=')[1].split('&')[0];
            
            // Parse time inputs with default value of 0 if empty or invalid
            let startTimeHour = parseInt(document.getElementById('add-form').elements['start-time-hour'].value) || 0;
            let startTimeMinute = parseInt(document.getElementById('add-form').elements['start-time-minute'].value) || 0;
            let startTimeSecond = parseInt(document.getElementById('add-form').elements['start-time-second'].value) || 0;
            let endTimeHour = parseInt(document.getElementById('add-form').elements['end-time-hour'].value) || 0;
            let endTimeMinute = parseInt(document.getElementById('add-form').elements['end-time-minute'].value) || 0;
            let endTimeSecond = parseInt(document.getElementById('add-form').elements['end-time-second'].value) || 0;
            
            // Calculate total seconds
            let startSeconds = startTimeHour * 3600 + startTimeMinute * 60 + startTimeSecond;
            let endSeconds = endTimeHour * 3600 + endTimeMinute * 60 + endTimeSecond;
            
            // If end time is 0 or not after start time, fetch video duration
            if (endSeconds <= startSeconds) {
                try {
                    // Create a temporary player to get video duration
                    const tempDiv = document.createElement('div');
                    tempDiv.id = 'temp-player';
                    tempDiv.style.display = 'none';
                    document.body.appendChild(tempDiv);
                    
                    // Wait for video to load and get duration
                    const duration = await new Promise((resolve, reject) => {
                        const tempPlayer = new YT.Player('temp-player', {
                            height: '1',
                            width: '1',
                            videoId: videoId,
                            events: {
                                'onReady': function(event) {
                                    const dur = event.target.getDuration();
                                    event.target.destroy();
                                    document.body.removeChild(tempDiv);
                                    resolve(Math.floor(dur));
                                },
                                'onError': function(event) {
                                    event.target.destroy();
                                    document.body.removeChild(tempDiv);
                                    reject(new Error('Could not load video'));
                                }
                            }
                        });
                        
                        // Timeout after 10 seconds
                        setTimeout(() => {
                            if (tempPlayer) {
                                tempPlayer.destroy();
                                document.body.removeChild(tempDiv);
                                reject(new Error('Timeout loading video'));
                            }
                        }, 10000);
                    });
                    
                    endSeconds = duration;
                    console.log(`Auto-detected video duration: ${duration} seconds`);
                } catch (error) {
                    console.error('Error fetching video duration:', error);
                    alert('Could not automatically detect video duration. Please enter an end time manually.');
                    return;
                }
            }
            
            playList.push({
                videoId: videoId,
                start: startSeconds,
                end: endSeconds
            });
            textarea.value = JSON.stringify(playList);
            updatePlayList();
            
            // Clear the form after adding
            document.getElementById('youtube-link').value = '';
            document.getElementById('add-form').elements['start-time-hour'].value = '0';
            document.getElementById('add-form').elements['start-time-minute'].value = '0';
            document.getElementById('add-form').elements['start-time-second'].value = '0';
            document.getElementById('add-form').elements['end-time-hour'].value = '0';
            document.getElementById('add-form').elements['end-time-minute'].value = '0';
            document.getElementById('add-form').elements['end-time-second'].value = '0';
        });
    </script>
</body>

</html>
