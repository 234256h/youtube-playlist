<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>YouTube Playlist Duration Calculator & Player</title>
    <!-- Version 3.7 - Adding version number as a variable -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #cc0000;
            text-align: center;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #cc0000;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        button:hover {
            background-color: #990000;
        }
        #result {
            margin-top: 0;
            padding: 15px;
            border-radius: 4px;
            background-color: #f0f0f0;
            display: none;
            order: 2;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #cc0000;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #cc0000;
            font-weight: bold;
            display: none;
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #cc0000;
            background-color: #ffeeee;
        }
        .error small {
            font-weight: normal;
            color: #666;
            display: block;
            margin-top: 5px;
        }
        .video-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .progress-container {
            margin: 15px 0;
            display: none;
        }
        .progress-bar {
            width: 100%;
            background-color: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress {
            height: 20px;
            background-color: #cc0000;
            width: 0%;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s;
        }
        .option-group {
            margin-top: 15px;
        }
        .checkbox-group {
            margin-bottom: 10px;
        }
        .player-container {
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        .player-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
        }
        .player-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .sections {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .section {
            flex: 1;
            min-width: 300px;
        }
        .clickable-row {
            cursor: pointer;
        }
        .clickable-row:hover {
            background-color: #f5f5f5;
        }
        .button-group {
            margin-top: 20px;
        }
        .active-video {
            background-color: #ffeeee;
        }
        /* Google Sign-In styles */
        .google-signin-container {
            margin: 15px 0;
        }
        
        .auth-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .small-btn {
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        #signin-status {
            color: #4CAF50;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .signin-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .info {
            background-color: #e1f5fe;
            border-left: 4px solid #03a9f4;
        }

        .success {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        
        /* Version indicator and footer */
        .version-info {
            background-color: #f5f5f5;
            padding: 8px 16px;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
            color: #666;
            font-size: 12px;
        }
        
        .version-badge {
            display: inline-block;
            background-color: #03a9f4;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .page-footer {
            margin-top: 40px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            text-align: center;
            color: #888;
            font-size: 12px;
            order: 3;
        }
        
        /* New styles for OAuth notification */
        .oauth-note {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border-left: 5px solid #ffeeba;
        }
        .top-hour-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 4px solid #4caf50;
            border-radius: 4px;
        }

        .top-hour-info h3 {
            margin-top: 0;
            color: #4caf50;
        }

        .explanation {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }

        .next-hour-start {
            margin-top: 10px;
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
        }

        .next-hour-start strong {
            color: #4caf50;
            font-size: 1.1em;
        }

        /* This is the key style to swap the order visually without changing HTML */
        #player-container {
            order: 1; /* This will appear first */
        }

        /* Keep these above the rest of the content */
        .input-group, .option-group, #calculateBtn, #loading, #progress-container, #error, h1, .version-info {
            order: 0;
        }
    </style>
    <script>
        // Define version number as a variable at the top
        const APP_VERSION = "3.7";
        // Rest of your script will follow...

        // Global variables (simplified)
        let calcPlayer = null;
        let youtubePlayer = null;
        let playlistId = null;
        let videoData = [];
        let playlistTitle = "YouTube Playlist";
        let currentVideoIndex = 0;
        const YOUTUBE_API_KEY = 'AIzaSyD3EZr_d99qLJX_2gZQuaENVCbClbjgHWE'; // Use your actual key

        // Helper function to parse duration
        function parseDuration(duration) {
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return 0; // Handle cases where regex doesn't match
            const hours = parseInt(match[1] || 0);
            const minutes = parseInt(match[2] || 0);
            const seconds = parseInt(match[3] || 0);
            return hours * 3600 + minutes * 60 + seconds;
        }

        // *** Define fetchPlaylistDataFromYouTubeAPI BEFORE startCalculation ***
        async function fetchPlaylistDataFromYouTubeAPI(pId, showDetails) {
            console.log(`Fetching API data for Playlist ID: ${pId}, Show Details: ${showDetails}`);
            const loadingDiv = document.getElementById('loading');
            try {
                // Fetch playlist details
                const playlistResponse = await fetch(
                    `https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${pId}&key=${YOUTUBE_API_KEY}`
                );
                if (!playlistResponse.ok) {
                    const errorData = await playlistResponse.json().catch(() => ({})); // Try to parse error, default to empty obj
                    console.error("API Error (Playlist Details):", playlistResponse.status, errorData);
                    throw new Error(`Failed to fetch playlist details: ${errorData?.error?.message || playlistResponse.statusText} (Status: ${playlistResponse.status})`);
                }
                const playlistData = await playlistResponse.json();
                if (!playlistData.items || playlistData.items.length === 0) {
                    throw new Error('Playlist not found or is empty/private.');
                }
                playlistTitle = playlistData.items[0].snippet.title || "YouTube Playlist";
                console.log("Playlist Title:", playlistTitle);

                // Fetch playlist items (videos)
                let videos = [];
                let nextPageToken = null;
                let page = 1;
                do {
                    console.log(`Fetching playlist items page ${page++}...`);
                    const videosResponse = await fetch(
                        `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&maxResults=50&playlistId=${pId}${nextPageToken ? `&pageToken=${nextPageToken}` : ''}&key=${YOUTUBE_API_KEY}`
                    );
                    if (!videosResponse.ok) {
                        const errorData = await videosResponse.json().catch(() => ({}));
                        console.error("API Error (Playlist Items):", videosResponse.status, errorData);
                        throw new Error(`Failed to fetch playlist items: ${errorData?.error?.message || videosResponse.statusText} (Status: ${videosResponse.status})`);
                    }
                    const videosPageData = await videosResponse.json();
                    if (!videosPageData.items) {
                        console.warn("No items found on this page, but continuing if nextPageToken exists.");
                    } else {
                         videos = videos.concat(videosPageData.items);
                    }
                    nextPageToken = videosPageData.nextPageToken;
                } while (nextPageToken);
                console.log(`Fetched a total of ${videos.length} video items.`);

                if (videos.length === 0) {
                    throw new Error("No videos found in the playlist.");
                }

                // Prepare video data structure
                videoData = videos
                    .filter(item => item.snippet && item.snippet.title && item.contentDetails && item.contentDetails.videoId) // Basic validation
                    .map(item => ({
                        title: item.snippet.title,
                        duration: 0, // Will be filled if showDetails is true
                        videoId: item.contentDetails.videoId,
                        error: false
                    }));

                if (showDetails) {
                    console.log("Fetching detailed video durations...");
                    // Batch fetch video details for duration
                    const videoIds = videoData.map(v => v.videoId);
                    let detailedVideoInfo = [];
                    const batchSize = 50;
                    for (let i = 0; i < videoIds.length; i += batchSize) {
                        const batchIds = videoIds.slice(i, i + batchSize).join(',');
                        console.log(`Fetching details for batch ${Math.floor(i / batchSize) + 1}...`);
                        const detailsResponse = await fetch(
                            `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${batchIds}&key=${YOUTUBE_API_KEY}`
                        );
                         if (!detailsResponse.ok) {
                            const errorData = await detailsResponse.json().catch(() => ({}));
                            console.error("API Error (Video Details):", detailsResponse.status, errorData);
                            // Don't throw here, just log and continue - some videos might be unavailable
                            console.warn(`Failed to fetch details for batch starting at index ${i}. Some durations might be missing.`);
                            continue; // Skip this batch
                        }
                        const detailsData = await detailsResponse.json();
                        if(detailsData.items) {
                            detailedVideoInfo = detailedVideoInfo.concat(detailsData.items);
                        }
                    }

                    // Create a map for easy lookup
                    const detailsMap = new Map(detailedVideoInfo.map(item => [item.id, item.contentDetails]));

                    // Update videoData with durations
                    let totalSeconds = 0;
                    let validVideos = 0;
                    videoData = videoData.map(video => {
                        const details = detailsMap.get(video.videoId);
                        if (details && details.duration) {
                            const durationSeconds = parseDuration(details.duration);
                            if (durationSeconds > 0) { // Ensure duration is valid
                                video.duration = durationSeconds;
                                totalSeconds += durationSeconds;
                                validVideos++;
                            } else {
                                console.warn(`Invalid duration format for video ${video.videoId}: ${details.duration}`);
                                video.error = true; // Mark as error if duration couldn't be parsed
                            }
                        } else {
                             console.warn(`No duration details found for video ${video.videoId}.`);
                             video.error = true; // Mark as error if details are missing
                        }
                        return video;
                    });
                    console.log(`Processed details for ${validVideos} videos. Total duration: ${totalSeconds}s`);
                    loadingDiv.style.display = 'none';
                    displayResults(playlistTitle, videoData.length, validVideos, totalSeconds, true);
                } else {
                    // Fast mode without details: estimate duration
                    console.log("Estimating duration (Fast Mode without details).");
                    const estimatedDuration = videoData.length * 480; // 8 min average
                    loadingDiv.style.display = 'none';
                    displayResults(playlistTitle, videoData.length, videoData.length, estimatedDuration, false);
                    // Add note about estimation
                    const durationInfoDiv = document.getElementById('durationInfo');
                    if(durationInfoDiv) {
                         durationInfoDiv.innerHTML += `<p><strong>Note:</strong> Duration is estimated. Check "Show Detailed Duration" for accuracy.</p>`;
                    }
                }

                // Start playback regardless of details shown
                startPlayback();

            } catch (error) {
                console.error('Error in fetchPlaylistDataFromYouTubeAPI:', error);
                showError(`API Error: ${error.message}. Please check the console for details.`);
                loadingDiv.style.display = 'none';
                // Optionally: Fallback to iframe method if API fails?
                // initCalculationPlayer(showDetails); // Example fallback
            }
        }

        // Define extractPlaylistId BEFORE startCalculation
        function extractPlaylistId(url) {
            console.log("Extracting Playlist ID from:", url);
            try {
                const urlObj = new URL(url);
                const searchParams = urlObj.searchParams;
                if (searchParams.has('list')) {
                    const listId = searchParams.get('list');
                    console.log("Found ID via URLSearchParams:", listId);
                    return listId;
                }
            } catch (e) {
                console.warn("URL parsing failed, trying regex:", e.message);
            }
            const playlistMatch = url.match(/[?&]list=([a-zA-Z0-9_-]+)/i);
            if (playlistMatch && playlistMatch[1]) {
                console.log("Found ID via regex:", playlistMatch[1]);
                return playlistMatch[1];
            }
            if (/^PL[a-zA-Z0-9_-]{16,}/.test(url)) {
                 console.log("Assuming input is direct Playlist ID:", url);
                 return url;
            }
            console.error("Failed to extract playlist ID.");
            return null;
        }

        // startCalculation function definition
        function startCalculation() {
            console.log("startCalculation triggered!");
            const playlistUrlInput = document.getElementById('playlistUrl');
            const playlistUrl = playlistUrlInput.value.trim();
            console.log("Value read from #playlistUrl input:", playlistUrl);
            const fastMode = document.getElementById('fastMode').checked;
            const showDetails = document.getElementById('showDetails').checked;
            const resultDiv = document.getElementById('result');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const progressContainer = document.getElementById('progress-container');
            const playerContainer = document.getElementById('player-container');

            // Reset UI
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            errorDiv.innerHTML = ''; // Clear previous errors
            playerContainer.style.display = 'none';
            if (youtubePlayer) { // Destroy existing player if any
                 youtubePlayer.destroy();
                 youtubePlayer = null;
            }
            videoData = [];

            console.log("UI Reset.");

            if (!playlistUrl) {
                showError('Please enter a YouTube playlist URL');
                console.error("No playlist URL entered.");
                return;
            }

            playlistId = extractPlaylistId(playlistUrl);
            console.log("Playlist ID Extracted:", playlistId);

            if (!playlistId) {
                showError('Could not extract playlist ID from URL. Make sure it is valid.');
                console.error("Invalid Playlist ID.");
                return;
            }

            loadingDiv.style.display = 'block'; // Show loading indicator
            console.log("Loading shown. Fast Mode:", fastMode);

            // Destroy calculation player if it exists from previous run
            if (calcPlayer) {
                calcPlayer.destroy();
                calcPlayer = null;
            }
            
            if (fastMode) {
                console.log("Calling fetchPlaylistDataFromYouTubeAPI...");
                fetchPlaylistDataFromYouTubeAPI(playlistId, showDetails);
                } else {
                console.log("Calling initCalculationPlayer...");
                progressContainer.style.display = 'block'; // Show progress for slow mode
                // Ensure YouTube API is ready before initializing
                    if (typeof YT !== 'undefined' && YT.loaded) {
                        initCalculationPlayer(showDetails);
                } else {
                    // If API isn't loaded yet, wait for onYouTubeIframeAPIReady
                    console.log("YouTube API not ready, waiting for onYouTubeIframeAPIReady.");
                    // onYouTubeIframeAPIReady should handle calling initCalculationPlayer
                }
            }
        }

        // Simplified Player Initialization Functions
        function initYoutubePlayer() {
            console.log("initYoutubePlayer called for playlist:", playlistId);
            // Ensure target div exists
            const playerTarget = document.getElementById('youtube-player');
            if (!playerTarget) {
                console.error("Player target div #youtube-player not found!");
                showError("Player initialization failed: Target element missing.");
                return;
            }

            // Destroy existing player if it wasn't destroyed properly
            if (youtubePlayer) {
                console.warn("Destroying existing youtubePlayer instance before creating new one.");
                youtubePlayer.destroy();
                youtubePlayer = null;
            }

            console.log("Creating new YT.Player instance for playback.");
            youtubePlayer = new YT.Player('youtube-player', {
                height: '390',
                width: '640',
                playerVars: {
                    listType: 'playlist',
                    list: playlistId,
                    controls: 1, autoplay: 1, rel: 0, modestbranding: 1, fs: 1, iv_load_policy: 3, enablejsapi: 1
                },
                events: {
                    'onReady': onPlaybackPlayerReady,
                    'onStateChange': onPlaybackPlayerStateChange,
                    'onError': onPlaybackPlayerError // Ensure this handler exists
                }
            });
        }

        function initCalculationPlayer(showDetails) {
             console.log("initCalculationPlayer called for playlist:", playlistId);
             // Ensure target div exists
             const playerTarget = document.getElementById('youtube-player');
             if (!playerTarget) {
                 console.error("Calculation Player target div #youtube-player not found!");
                 showError("Calculation initialization failed: Target element missing.");
                 return;
             }

             // Destroy existing calculation player if any
            if (calcPlayer) {
                 console.warn("Destroying existing calcPlayer instance before creating new one.");
                calcPlayer.destroy();
                 calcPlayer = null;
            }
            
             console.log("Creating new YT.Player instance for calculation.");
             calcPlayer = new YT.Player('youtube-player', { // Use the same target div, but hidden
                height: '0',
                width: '0',
                 playerVars: { listType: 'playlist', list: playlistId },
                events: {
                    'onReady': (event) => onCalculationPlayerReady(event, showDetails),
                    'onStateChange': onCalculationPlayerStateChange,
                     'onError': onCalculationPlayerError // Ensure this handler exists
                }
            });
        }
        
        // The rest of your functions (fetchPlaylistDataFromYouTubeAPI, parseDuration, etc.)
        // should remain largely the same, but ensure they have console.log statements
        // at key points, especially in `catch` blocks and when updating the UI.

        // Ensure API Ready function handles the non-fast mode case
        function onYouTubeIframeAPIReady() {
            console.log("onYouTubeIframeAPIReady fired.");
            // If we were waiting to initialize the calculation player, do it now
            const fastMode = document.getElementById('fastMode').checked;
            if (!fastMode && playlistId && !calcPlayer) {
                 console.log("API Ready: Initializing Calculation Player now.");
                 const showDetails = document.getElementById('showDetails').checked;
                 initCalculationPlayer(showDetails);
            }
        }

        // Add console logs to UI update functions
         function displayResults(title, total, valid, seconds, details) {
             console.log(`displayResults called: Title=${title}, Total=${total}, Valid=${valid}, Seconds=${seconds}, Details=${details}`);
             
             // Format the duration
             const hours = Math.floor(seconds / 3600);
             const minutes = Math.floor((seconds % 3600) / 60);
             const secs = seconds % 60;
             const formattedDuration = `${hours}h ${minutes}m ${secs}s`;
             
             // Calculate average video length
             const avgSeconds = valid > 0 ? Math.round(seconds / valid) : 0;
             const avgMinutes = Math.floor(avgSeconds / 60);
             const avgSecs = avgSeconds % 60;
             
             // Update the UI with playlist info
             document.getElementById('playlistInfo').innerHTML = `
                 <h3>${title}</h3>
                 <p><strong>Total videos:</strong> ${total}</p>
                 <p><strong>Available videos:</strong> ${valid}</p>
             `;
             
             // Update the UI with duration info
             document.getElementById('durationInfo').innerHTML = `
                 <p><strong>Total duration:</strong> ${formattedDuration}</p>
                 <p><strong>Average video length:</strong> ${avgMinutes}m ${avgSecs}s</p>
             `;
             
             // Show video details if available
             if (details && videoData.length > 0) {
                 const tableRows = videoData.map((video, index) => `
                     <tr class="clickable-row ${index === currentVideoIndex ? 'active-video' : ''}" data-index="${index}">
                         <td>${index + 1}</td>
                         <td>${video.title}</td>
                         <td>${video.error ? 'N/A' : formatDuration(video.duration)}</td>
                     </tr>
                 `).join('');
                 
                 // Use the correct element ID - videoTableBody instead of videoList
                 document.getElementById('videoTableBody').innerHTML = tableRows;
                 
                 // Add click event to rows for video selection
                 document.querySelectorAll('.clickable-row').forEach(row => {
                     row.addEventListener('click', function() {
                         const index = parseInt(this.getAttribute('data-index'));
                         currentVideoIndex = index;
                         if (youtubePlayer) {
                             youtubePlayer.loadVideoById(videoData[index].videoId);
                         }
                         document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active-video'));
                         this.classList.add('active-video');
                     });
                 });
             }
             
             // Helper function to format duration in a readable format
             function formatDuration(seconds) {
                 const h = Math.floor(seconds / 3600);
                 const m = Math.floor((seconds % 3600) / 60);
                 const s = seconds % 60;
                 return h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;
             }
             
             // Show the results section
             document.getElementById('result').style.display = 'block';
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

         function startPlayback() {
             console.log("startPlayback called.");
             document.getElementById('player-container').style.display = 'block'; // Show player container
             initYoutubePlayer();
         }

         function showError(message) {
             console.error("showError called:", message);
             const errorDiv = document.getElementById('error');
             errorDiv.innerHTML = message; // Use innerHTML to allow <br> etc.
             errorDiv.style.display = 'block';
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

         // Add handlers for player errors if they don't exist
         function onPlaybackPlayerError(event) {
             console.error('Playback Player Error:', event.data);
             showError(`Video playback error occurred (Code: ${event.data}). Please try refreshing or check the console.`);
         }
         
         function onPlaybackPlayerReady(event) {
             console.log('Playback Player Ready');
             // Start playing the first video in the playlist
             if (videoData.length > 0) {
                 event.target.loadVideoById(videoData[currentVideoIndex].videoId);
             }
         }
         
         function onPlaybackPlayerStateChange(event) {
             console.log('Playback Player State Changed:', event.data);
             // You can add additional handling for player state changes here
             // YT.PlayerState.ENDED = 0
             // YT.PlayerState.PLAYING = 1
             // YT.PlayerState.PAUSED = 2
             // YT.PlayerState.BUFFERING = 3
         }

         function onCalculationPlayerError(event) {
             console.error('Calculation Player Error:', event.data);
             // Handle calculation errors with specific messages based on error code
             let errorMessage = `Error during playlist processing (Code: ${event.data}).`;
             
             // YouTube API error codes
             switch(event.data) {
                 case 2:
                     errorMessage += " Invalid parameter in the request.";
                     break;
                 case 5:
                     errorMessage += " Content cannot be played in an HTML5 player or another error related to the HTML5 player.";
                     break;
                 case 100:
                     errorMessage += " Video requested was not found. This could be because the video has been removed or marked as private.";
                     break;
                 case 101:
                 case 150:
                     errorMessage += " Video owner does not allow it to be played in embedded players or on other websites.";
                     break;
             }
             
             showError(errorMessage);
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

        // Make sure ALL other functions (like onCalculationPlayerReady, fetchPlaylistDataFromYouTubeAPI, etc.)
        // are present and correctly defined.

        document.addEventListener('DOMContentLoaded', function() {
            // Set version numbers
            document.getElementById('version-number').textContent = APP_VERSION;
            document.getElementById('footer-version').textContent = APP_VERSION;

            // Set timestamps
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' };
            const formattedTime = now.toLocaleString('en-US', options);
            document.getElementById('build-time').textContent = 'Last updated: ' + formattedTime;
            document.getElementById('footer-time').textContent = formattedTime;

            // Attach button listener
            document.getElementById('calculateBtn').addEventListener('click', startCalculation);

            // Attach Enter key listener
            document.getElementById('playlistUrl').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    startCalculation();
                }
            });

            // Hide OAuth note if not needed (assuming API key usage)
            const oauthNote = document.querySelector('.oauth-note');
            if (oauthNote) oauthNote.style.display = 'none';

            console.log("DOM Ready, Listeners Attached. Version:", APP_VERSION);
        });

        // *** Crucial Step: Add Console Logging to startCalculation ***
        function startCalculation() {
            console.log("startCalculation triggered!"); // Check if function runs

            const playlistUrl = document.getElementById('playlistUrl').value.trim();
            const fastMode = document.getElementById('fastMode').checked;
            const showDetails = document.getElementById('showDetails').checked;
            const resultDiv = document.getElementById('result');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const progressContainer = document.getElementById('progress-container');
            const playerContainer = document.getElementById('player-container');

            // Reset UI
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            errorDiv.innerHTML = ''; // Clear previous errors
            playerContainer.style.display = 'none';
            if (youtubePlayer) { // Destroy existing player if any
                 youtubePlayer.destroy();
                 youtubePlayer = null;
            }
            videoData = [];

            console.log("UI Reset.");

            if (!playlistUrl) {
                showError('Please enter a YouTube playlist URL');
                console.error("No playlist URL entered.");
                return;
            }

            playlistId = extractPlaylistId(playlistUrl);
            console.log("Playlist ID Extracted:", playlistId);

            if (!playlistId) {
                showError('Could not extract playlist ID from URL. Make sure it is valid.');
                console.error("Invalid Playlist ID.");
                return;
            }

            loadingDiv.style.display = 'block'; // Show loading indicator
            console.log("Loading shown. Fast Mode:", fastMode);

            // Destroy calculation player if it exists from previous run
            if (calcPlayer) {
                calcPlayer.destroy();
                calcPlayer = null;
            }
            
            if (fastMode) {
                console.log("Calling fetchPlaylistDataFromYouTubeAPI...");
                fetchPlaylistDataFromYouTubeAPI(playlistId, showDetails);
                } else {
                console.log("Calling initCalculationPlayer...");
                progressContainer.style.display = 'block'; // Show progress for slow mode
                // Ensure YouTube API is ready before initializing
                    if (typeof YT !== 'undefined' && YT.loaded) {
                        initCalculationPlayer(showDetails);
                } else {
                    // If API isn't loaded yet, wait for onYouTubeIframeAPIReady
                    console.log("YouTube API not ready, waiting for onYouTubeIframeAPIReady.");
                    // onYouTubeIframeAPIReady should handle calling initCalculationPlayer
                }
            }
        }

        // Simplified Player Initialization Functions
        function initYoutubePlayer() {
            console.log("initYoutubePlayer called for playlist:", playlistId);
            // Ensure target div exists
            const playerTarget = document.getElementById('youtube-player');
            if (!playerTarget) {
                console.error("Player target div #youtube-player not found!");
                showError("Player initialization failed: Target element missing.");
                return;
            }

            // Destroy existing player if it wasn't destroyed properly
            if (youtubePlayer) {
                console.warn("Destroying existing youtubePlayer instance before creating new one.");
                youtubePlayer.destroy();
                youtubePlayer = null;
            }

            console.log("Creating new YT.Player instance for playback.");
            youtubePlayer = new YT.Player('youtube-player', {
                height: '390',
                width: '640',
                playerVars: {
                    listType: 'playlist',
                    list: playlistId,
                    controls: 1, autoplay: 1, rel: 0, modestbranding: 1, fs: 1, iv_load_policy: 3, enablejsapi: 1
                },
                events: {
                    'onReady': onPlaybackPlayerReady,
                    'onStateChange': onPlaybackPlayerStateChange,
                    'onError': onPlaybackPlayerError // Ensure this handler exists
                }
            });
        }

        function initCalculationPlayer(showDetails) {
             console.log("initCalculationPlayer called for playlist:", playlistId);
             // Ensure target div exists
             const playerTarget = document.getElementById('youtube-player');
             if (!playerTarget) {
                 console.error("Calculation Player target div #youtube-player not found!");
                 showError("Calculation initialization failed: Target element missing.");
                 return;
             }

             // Destroy existing calculation player if any
            if (calcPlayer) {
                 console.warn("Destroying existing calcPlayer instance before creating new one.");
                calcPlayer.destroy();
                 calcPlayer = null;
            }
            
             console.log("Creating new YT.Player instance for calculation.");
             calcPlayer = new YT.Player('youtube-player', { // Use the same target div, but hidden
                height: '0',
                width: '0',
                 playerVars: { listType: 'playlist', list: playlistId },
                events: {
                    'onReady': (event) => onCalculationPlayerReady(event, showDetails),
                    'onStateChange': onCalculationPlayerStateChange,
                     'onError': onCalculationPlayerError // Ensure this handler exists
                }
            });
        }
        
        // The rest of your functions (fetchPlaylistDataFromYouTubeAPI, parseDuration, etc.)
        // should remain largely the same, but ensure they have console.log statements
        // at key points, especially in `catch` blocks and when updating the UI.

        // Ensure API Ready function handles the non-fast mode case
        function onYouTubeIframeAPIReady() {
            console.log("onYouTubeIframeAPIReady fired.");
            // If we were waiting to initialize the calculation player, do it now
            const fastMode = document.getElementById('fastMode').checked;
            if (!fastMode && playlistId && !calcPlayer) {
                 console.log("API Ready: Initializing Calculation Player now.");
                 const showDetails = document.getElementById('showDetails').checked;
                 initCalculationPlayer(showDetails);
            }
        }

        // Add console logs to UI update functions
         function displayResults(title, total, valid, seconds, details) {
             console.log(`displayResults called: Title=${title}, Total=${total}, Valid=${valid}, Seconds=${seconds}, Details=${details}`);
             
             // Format the duration
             const hours = Math.floor(seconds / 3600);
             const minutes = Math.floor((seconds % 3600) / 60);
             const secs = seconds % 60;
             const formattedDuration = `${hours}h ${minutes}m ${secs}s`;
             
             // Calculate average video length
             const avgSeconds = valid > 0 ? Math.round(seconds / valid) : 0;
             const avgMinutes = Math.floor(avgSeconds / 60);
             const avgSecs = avgSeconds % 60;
             
             // Update the UI with playlist info
             document.getElementById('playlistInfo').innerHTML = `
                 <h3>${title}</h3>
                 <p><strong>Total videos:</strong> ${total}</p>
                 <p><strong>Available videos:</strong> ${valid}</p>
             `;
             
             // Update the UI with duration info
             document.getElementById('durationInfo').innerHTML = `
                 <p><strong>Total duration:</strong> ${formattedDuration}</p>
                 <p><strong>Average video length:</strong> ${avgMinutes}m ${avgSecs}s</p>
             `;
             
             // Show video details if available
             if (details && videoData.length > 0) {
                 const tableRows = videoData.map((video, index) => `
                     <tr class="clickable-row ${index === currentVideoIndex ? 'active-video' : ''}" data-index="${index}">
                         <td>${index + 1}</td>
                         <td>${video.title}</td>
                         <td>${video.error ? 'N/A' : formatDuration(video.duration)}</td>
                     </tr>
                 `).join('');
                 
                 // Use the correct element ID - videoTableBody instead of videoList
                 document.getElementById('videoTableBody').innerHTML = tableRows;
                 
                 // Add click event to rows for video selection
                 document.querySelectorAll('.clickable-row').forEach(row => {
                     row.addEventListener('click', function() {
                         const index = parseInt(this.getAttribute('data-index'));
                         currentVideoIndex = index;
                         if (youtubePlayer) {
                             youtubePlayer.loadVideoById(videoData[index].videoId);
                         }
                         document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active-video'));
                         this.classList.add('active-video');
                     });
                 });
             }
             
             // Helper function to format duration in a readable format
             function formatDuration(seconds) {
                 const h = Math.floor(seconds / 3600);
                 const m = Math.floor((seconds % 3600) / 60);
                 const s = seconds % 60;
                 return h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;
             }
             
             // Show the results section
             document.getElementById('result').style.display = 'block';
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

         function startPlayback() {
             console.log("startPlayback called.");
             document.getElementById('player-container').style.display = 'block'; // Show player container
             initYoutubePlayer();
         }

         function showError(message) {
             console.error("showError called:", message);
             const errorDiv = document.getElementById('error');
             errorDiv.innerHTML = message; // Use innerHTML to allow <br> etc.
             errorDiv.style.display = 'block';
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

         // Add handlers for player errors if they don't exist
         function onPlaybackPlayerError(event) {
             console.error('Playback Player Error:', event.data);
             showError(`Video playback error occurred (Code: ${event.data}). Please try refreshing or check the console.`);
         }
         
         function onPlaybackPlayerReady(event) {
             console.log('Playback Player Ready');
             // Start playing the first video in the playlist
             if (videoData.length > 0) {
                 event.target.loadVideoById(videoData[currentVideoIndex].videoId);
             }
         }
         
         function onPlaybackPlayerStateChange(event) {
             console.log('Playback Player State Changed:', event.data);
             // You can add additional handling for player state changes here
             // YT.PlayerState.ENDED = 0
             // YT.PlayerState.PLAYING = 1
             // YT.PlayerState.PAUSED = 2
             // YT.PlayerState.BUFFERING = 3
         }

         function onCalculationPlayerError(event) {
             console.error('Calculation Player Error:', event.data);
             // Handle calculation errors with specific messages based on error code
             let errorMessage = `Error during playlist processing (Code: ${event.data}).`;
             
             // YouTube API error codes
             switch(event.data) {
                 case 2:
                     errorMessage += " Invalid parameter in the request.";
                     break;
                 case 5:
                     errorMessage += " Content cannot be played in an HTML5 player or another error related to the HTML5 player.";
                     break;
                 case 100:
                     errorMessage += " Video requested was not found. This could be because the video has been removed or marked as private.";
                     break;
                 case 101:
                 case 150:
                     errorMessage += " Video owner does not allow it to be played in embedded players or on other websites.";
                     break;
             }
             
             showError(errorMessage);
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

        // Make sure ALL other functions (like onCalculationPlayerReady, fetchPlaylistDataFromYouTubeAPI, etc.)
        // are present and correctly defined.
    </script>
</head>
<body>
    <div class="container">
        <h1>YouTube Playlist Duration Calculator & Player</h1>
        <div class="version-info">
            <span class="version-badge">v<span id="version-number">2.9</span></span>
            <span id="build-time">Last updated: May 17, 2024, 17:25 UTC</span>
        </div>
        
        <div class="oauth-note">
            <strong>Important:</strong> This application must be accessed through a web server (http:// or https://) for Google Sign-In to work. 
            If you're seeing authentication errors, please use one of these methods:
            <ol>
                <li>Run a local web server and access via http://localhost:PORT/playlist-calculator.html</li>
                <li>Upload to a hosting service that provides HTTPS</li>
            </ol>
        </div>
        
        <div class="input-group">
            <label for="playlistUrl">Enter YouTube Playlist URL:</label>
            <input type="text" id="playlistUrl" 
                placeholder="https://www.youtube.com/playlist?list=PLxxx or https://www.youtube.com/watch?v=xxx&list=PLxxx">
        </div>
        
        <div class="option-group">
            <div class="checkbox-group">
                <input type="checkbox" id="fastMode" checked>
                <label for="fastMode">Fast Mode (uses YouTube API)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showDetails" checked>
                <label for="showDetails">Show Detailed Duration (slower but more accurate)</label>
            </div>
        </div>
        
        <button id="calculateBtn">Calculate Duration</button>
        
        <div id="loading" class="loading">
            <div class="loader"></div>
            <p>Loading and processing playlist data...</p>
        </div>
        
        <div id="progress-container" class="progress-container">
            <p>Processing: <span id="progress-text">0/0</span></p>
            <div class="progress-bar">
                <div id="progress" class="progress">0%</div>
            </div>
        </div>
        
        <div id="error" class="error"></div>
        
        <div id="result" style="display: none;">
            <h2>Results</h2>
            <div class="sections">
                <div class="section">
                    <div id="playlistInfo"></div>
                    <div id="durationInfo"></div>
                </div>
                <div class="section video-list">
                    <table id="videoTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody id="videoTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="player-container" class="player-container" style="display: none;">
            <div class="player-wrapper">
                <div id="youtube-player"></div>
            </div>
        </div>
        
        <div class="page-footer">
            YouTube Playlist Duration Calculator & Player - Version <span id="footer-version">2.9</span><br>
            Last updated: <span id="footer-time">May 17, 2024, 17:25 UTC</span><br>
            This tool allows you to calculate the total duration of any YouTube playlist.
        </div>
    </div>

    <script>
        // *** Crucial Step: Add Console Logging to startCalculation ***
        function startCalculation() {
            console.log("startCalculation triggered!"); // Check if function runs

            const playlistUrl = document.getElementById('playlistUrl').value.trim();
            const fastMode = document.getElementById('fastMode').checked;
            const showDetails = document.getElementById('showDetails').checked;
            const resultDiv = document.getElementById('result');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const progressContainer = document.getElementById('progress-container');
            const playerContainer = document.getElementById('player-container');

            // Reset UI
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            errorDiv.innerHTML = ''; // Clear previous errors
            playerContainer.style.display = 'none';
            if (youtubePlayer) { // Destroy existing player if any
                 youtubePlayer.destroy();
                 youtubePlayer = null;
            }
            videoData = [];

            console.log("UI Reset.");

            if (!playlistUrl) {
                showError('Please enter a YouTube playlist URL');
                console.error("No playlist URL entered.");
                return;
            }

            playlistId = extractPlaylistId(playlistUrl);
            console.log("Playlist ID Extracted:", playlistId);

            if (!playlistId) {
                showError('Could not extract playlist ID from URL. Make sure it is valid.');
                console.error("Invalid Playlist ID.");
                return;
            }

            loadingDiv.style.display = 'block'; // Show loading indicator
            console.log("Loading shown. Fast Mode:", fastMode);

            // Destroy calculation player if it exists from previous run
            if (calcPlayer) {
                calcPlayer.destroy();
                calcPlayer = null;
            }
            
            if (fastMode) {
                console.log("Calling fetchPlaylistDataFromYouTubeAPI...");
                fetchPlaylistDataFromYouTubeAPI(playlistId, showDetails);
                } else {
                console.log("Calling initCalculationPlayer...");
                progressContainer.style.display = 'block'; // Show progress for slow mode
                // Ensure YouTube API is ready before initializing
                    if (typeof YT !== 'undefined' && YT.loaded) {
                        initCalculationPlayer(showDetails);
                } else {
                    // If API isn't loaded yet, wait for onYouTubeIframeAPIReady
                    console.log("YouTube API not ready, waiting for onYouTubeIframeAPIReady.");
                    // onYouTubeIframeAPIReady should handle calling initCalculationPlayer
                }
            }
        }

        // Simplified Player Initialization Functions
        function initYoutubePlayer() {
            console.log("initYoutubePlayer called for playlist:", playlistId);
            // Ensure target div exists
            const playerTarget = document.getElementById('youtube-player');
            if (!playerTarget) {
                console.error("Player target div #youtube-player not found!");
                showError("Player initialization failed: Target element missing.");
                return;
            }

            // Destroy existing player if it wasn't destroyed properly
            if (youtubePlayer) {
                console.warn("Destroying existing youtubePlayer instance before creating new one.");
                youtubePlayer.destroy();
                youtubePlayer = null;
            }

            console.log("Creating new YT.Player instance for playback.");
            youtubePlayer = new YT.Player('youtube-player', {
                height: '390',
                width: '640',
                playerVars: {
                    listType: 'playlist',
                    list: playlistId,
                    controls: 1, autoplay: 1, rel: 0, modestbranding: 1, fs: 1, iv_load_policy: 3, enablejsapi: 1
                },
                events: {
                    'onReady': onPlaybackPlayerReady,
                    'onStateChange': onPlaybackPlayerStateChange,
                    'onError': onPlaybackPlayerError // Ensure this handler exists
                }
            });
        }

        function initCalculationPlayer(showDetails) {
             console.log("initCalculationPlayer called for playlist:", playlistId);
             // Ensure target div exists
             const playerTarget = document.getElementById('youtube-player');
             if (!playerTarget) {
                 console.error("Calculation Player target div #youtube-player not found!");
                 showError("Calculation initialization failed: Target element missing.");
                 return;
             }

             // Destroy existing calculation player if any
            if (calcPlayer) {
                 console.warn("Destroying existing calcPlayer instance before creating new one.");
                calcPlayer.destroy();
                 calcPlayer = null;
            }
            
             console.log("Creating new YT.Player instance for calculation.");
             calcPlayer = new YT.Player('youtube-player', { // Use the same target div, but hidden
                height: '0',
                width: '0',
                 playerVars: { listType: 'playlist', list: playlistId },
                events: {
                    'onReady': (event) => onCalculationPlayerReady(event, showDetails),
                    'onStateChange': onCalculationPlayerStateChange,
                     'onError': onCalculationPlayerError // Ensure this handler exists
                }
            });
        }
        
        // The rest of your functions (fetchPlaylistDataFromYouTubeAPI, parseDuration, etc.)
        // should remain largely the same, but ensure they have console.log statements
        // at key points, especially in `catch` blocks and when updating the UI.

        // Ensure API Ready function handles the non-fast mode case
        function onYouTubeIframeAPIReady() {
            console.log("onYouTubeIframeAPIReady fired.");
            // If we were waiting to initialize the calculation player, do it now
            const fastMode = document.getElementById('fastMode').checked;
            if (!fastMode && playlistId && !calcPlayer) {
                 console.log("API Ready: Initializing Calculation Player now.");
                 const showDetails = document.getElementById('showDetails').checked;
                 initCalculationPlayer(showDetails);
            }
        }

        // Add console logs to UI update functions
         function displayResults(title, total, valid, seconds, details) {
             console.log(`displayResults called: Title=${title}, Total=${total}, Valid=${valid}, Seconds=${seconds}, Details=${details}`);
             
             // Format the duration
             const hours = Math.floor(seconds / 3600);
             const minutes = Math.floor((seconds % 3600) / 60);
             const secs = seconds % 60;
             const formattedDuration = `${hours}h ${minutes}m ${secs}s`;
             
             // Calculate average video length
             const avgSeconds = valid > 0 ? Math.round(seconds / valid) : 0;
             const avgMinutes = Math.floor(avgSeconds / 60);
             const avgSecs = avgSeconds % 60;
             
             // Update the UI with playlist info
             document.getElementById('playlistInfo').innerHTML = `
                 <h3>${title}</h3>
                 <p><strong>Total videos:</strong> ${total}</p>
                 <p><strong>Available videos:</strong> ${valid}</p>
             `;
             
             // Update the UI with duration info
             document.getElementById('durationInfo').innerHTML = `
                 <p><strong>Total duration:</strong> ${formattedDuration}</p>
                 <p><strong>Average video length:</strong> ${avgMinutes}m ${avgSecs}s</p>
             `;
             
             // Show video details if available
             if (details && videoData.length > 0) {
                 const tableRows = videoData.map((video, index) => `
                     <tr class="clickable-row ${index === currentVideoIndex ? 'active-video' : ''}" data-index="${index}">
                         <td>${index + 1}</td>
                         <td>${video.title}</td>
                         <td>${video.error ? 'N/A' : formatDuration(video.duration)}</td>
                     </tr>
                 `).join('');
                 
                 // Use the correct element ID - videoTableBody instead of videoList
                 document.getElementById('videoTableBody').innerHTML = tableRows;
                 
                 // Add click event to rows for video selection
                 document.querySelectorAll('.clickable-row').forEach(row => {
                     row.addEventListener('click', function() {
                         const index = parseInt(this.getAttribute('data-index'));
                         currentVideoIndex = index;
                         if (youtubePlayer) {
                             youtubePlayer.loadVideoById(videoData[index].videoId);
                         }
                         document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active-video'));
                         this.classList.add('active-video');
                     });
                 });
             }
             
             // Helper function to format duration in a readable format
             function formatDuration(seconds) {
                 const h = Math.floor(seconds / 3600);
                 const m = Math.floor((seconds % 3600) / 60);
                 const s = seconds % 60;
                 return h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;
             }
             
             // Show the results section
             document.getElementById('result').style.display = 'block';
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

         function startPlayback() {
             console.log("startPlayback called.");
             document.getElementById('player-container').style.display = 'block'; // Show player container
             initYoutubePlayer();
         }

         function showError(message) {
             console.error("showError called:", message);
             const errorDiv = document.getElementById('error');
             errorDiv.innerHTML = message; // Use innerHTML to allow <br> etc.
             errorDiv.style.display = 'block';
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

         // Add handlers for player errors if they don't exist
         function onPlaybackPlayerError(event) {
             console.error('Playback Player Error:', event.data);
             showError(`Video playback error occurred (Code: ${event.data}). Please try refreshing or check the console.`);
         }
         
         function onPlaybackPlayerReady(event) {
             console.log('Playback Player Ready');
             // Start playing the first video in the playlist
             if (videoData.length > 0) {
                 event.target.loadVideoById(videoData[currentVideoIndex].videoId);
             }
         }
         
         function onPlaybackPlayerStateChange(event) {
             console.log('Playback Player State Changed:', event.data);
             // You can add additional handling for player state changes here
             // YT.PlayerState.ENDED = 0
             // YT.PlayerState.PLAYING = 1
             // YT.PlayerState.PAUSED = 2
             // YT.PlayerState.BUFFERING = 3
         }

         function onCalculationPlayerError(event) {
             console.error('Calculation Player Error:', event.data);
             // Handle calculation errors with specific messages based on error code
             let errorMessage = `Error during playlist processing (Code: ${event.data}).`;
             
             // YouTube API error codes
             switch(event.data) {
                 case 2:
                     errorMessage += " Invalid parameter in the request.";
                     break;
                 case 5:
                     errorMessage += " Content cannot be played in an HTML5 player or another error related to the HTML5 player.";
                     break;
                 case 100:
                     errorMessage += " Video requested was not found. This could be because the video has been removed or marked as private.";
                     break;
                 case 101:
                 case 150:
                     errorMessage += " Video owner does not allow it to be played in embedded players or on other websites.";
                     break;
             }
             
             showError(errorMessage);
             document.getElementById('loading').style.display = 'none';
             document.getElementById('progress-container').style.display = 'none';
         }

        // Make sure ALL other functions (like onCalculationPlayerReady, fetchPlaylistDataFromYouTubeAPI, etc.)
        // are present and correctly defined.
    </script>
</body>
</html>
